\documentclass{JAC2003}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{url}

%%   VARIABLE HEIGHT FOR THE TITLE BOX (default 35mm)
\setlength{\titleblockheight}{40mm}

\title{FOSS AT CERN: A DEVICE DRIVERS\\
	EXPERIENCE WITH THE LINUX KERNEL}
\author{%
	Juan David Gonz\'alez Cobas, Emilio Garc\'ia Cota,
	Samuel Iglesias Gons\'alvez,\\
	Julian Lewis, Javier Serrano, Manohar Vanga (CERN, Geneva),\\ 
	Alessandro Rubini (GNUDD, Pavia)}

\begin{document}

\maketitle
\begin{abstract}
    We describe the experience acquired during the integration of the
    \texttt{tsi148} driver
    into the main Linux kernel tree. The benefits (and some of the drawbacks) for
    long-term software maintenance are analysed, the most immediate one being the
    support and quality review added by an enormous  community of skilled
    developers. Indirect consequences are also analysed, and these are no less
    important: a serious impact in the style of the development process, the use of
    cutting edge tools and technologies supporting development, the adoption of the
    very strict standards enforced by the Linux kernel community, etc. These
    elements were also exported to the hardware development process in our section
    and we will explain how they were used with a particular example in mind: the
    development of the FMC family of boards following the Open Hardware philosophy,
    and how its architecture must fit the Linux model. This delicate interplay of
    hardware and software architectures is a perfect showcase of the benefits we
    get from  the strategic decision of having our drivers integrated in the
    kernel.  Finally, the case for a whole family of CERN-developed drivers for
    data acquisition models, the prospects for its integration in the kernel, and
    the adoption of a model parallel to Comedi, is also taken as an example of how
    this model will perform in the future.
\end{abstract}


\section{TSI148 DRIVER INTEGRATION IN THE KERNEL}
\subsection{Rationale}
The VME bus is a central component of the Controls System at CERN. We 
rely on 1140 FECs (Front End Computers), 710 of which are VME crates
with SBC (Single Board Computers). A process of renovation is in course,
involving the migration from 
\begin{Itemize}
\item CES RIO2/RIO3 SBCs with PowerPC CPUs runing LynxOS (around 605 crates), to
\item MEN-A20 SBCs with Intel CPUs running Linux (around 105)
\end{Itemize}

The MEN-A20 SBC incorporates a Tundra TSI148 VME-to-PCI-X bridge chip.
To support the functionalities required, and for maximum backward
comaptibility with the legacy CES API, a device driver was developed 
at CERN group BE/CO in spring 2009. Clearly, this is a strategical
component of the controls system: every VME device relies on the
provided programming interface to the VME bus. The CERN-developed driver
offers, therefore, a CES compatibility API to ease the transition during
the renovation process, and a new API more similar to common practice
in the Linux kernel.

After a period of validation and improvement taking place during 2010,
the strategic decision was taken to submit the driver for
inclusion in the mainline Linux kernel tree. The ongoing process, started
beginning 2011 and in course of completion, is described in the following
sections.

\subsection{Benefits}

There are many reasons that make the insertion of code in the mainline
kernel a desirable target.

\begin{Itemize}
\item Smoother maintenance in the (rather frequent) event of kernel API
    modification.
\item Very strict process of peer review of the code by knowledgeable
    and specialized maintainers.
\item Widespread distribution of the codebase, which can then be
    enhanced and get contributions by many other members of the community.
\item Faster cycle of bug fixes.
\item Being able to drive a critical hardware component with software
    in the stock kernel, with no local, idiosyncratic modifications.
\end{Itemize}

It is an interesting fact that the latter, which looks like a very
far-fetched reason for undertaking this project, turned out to be more
relevant as the process evolved. Renovated FECs at CERN controls system
are diskless machines, booting a custom kernel carefully configured and
patched to match local needs. Though this kernel is essentially a stock,
mainline tree from \url{http://kernel.org} with a very reduced 
configuration, the \verb|CONFIG_PREEMPT_RT|
patch set applied, plus many required local
tweaks, maintaining this system soon becomes a full time job requiring
great expertise and care, given its radical impact in the controls
system stability. The ability of relying on a stock kernel from a main
distribution alleviates this dependency on a dedicated maintainer, and
pushes strongly towards having the \texttt|tsi148| driver integrated
upstream.

\subsection{Drawbacks}

Some of the drawbacks herewith enumerated will be elaborated further in
the description of the integration process, but we summarize here the
most important ones.

\begin{Itemize}
\item It's hard. One should be ready for the peculiar culture of the
    Linux Kernel Mailing List.
\item Design, APIs and coding practice that is common or acceptable at
    CERN must possibly be adapted or completely rebuilt to comply with the
    strict standards of the Linux kernel development community. The morale
    is that the end product will almost certainly be different from what one
    initially settled for (but will also certainly be better).
\item One must be prepared to compromise. The most practical,
    short-lived solution might not be the technically perfect one kernel
    maintainers aim at.
\item Maintainers are occasionally hard to deal with.
\item The process may be long.
\item Gradual changes are likely to be better accepted that big chunks
    of code submitted out of the blue.  
\item Having a history of prior contributions gives more respectability
    and ease of acceptance.
\end{Itemize}

\subsection{The process}

Submission of source code for acceptance in the kernel is done by means
of patches. A fist attempt of integration of the \verb|tsi148| driver
was initiated in mid-2010 by one of the authors (Emilio Garc\'ia
Cota). 

By that time, there existed one \verb|tsi148| driver in the
\texttt{staging/} area of the kernel, maintained by Martyn Welch. This
driver belongs to a temptative support for the VME bus that also covers
the Tundra Universe chips, with work derived from VMELinux by John
Huggins and Michael Wyrick.

The set of patches initially submitted provided improvements in several
areas, mainly in closer compliance with Linux bus/device model.
Acceptance by the maintainer was partial, and mainly unrelated to core
system issues like the device model.

The submission was re-approached beginning 2011 by another of the
authors (Manohar Vanga). In this case, some bugs in the staging driver
were fixed, and the bulk of modifications concerning the device model
were partially acknowledged. This leads to a third iteration of the
process, and the re-issue of a third patch set in August 2011. At the
time of this writing, the definitive submission and acceptance of the
final set of patches (five changesets) is in its definitive stage, and
hopefully will be integrated in the next merge window.

\subsection{Current position}

At the time of this writing, the whole set of patches concerning bug
fixes and device model of the \verb|tsi148| VME bridge driver is
about to be finally accepted. There is still a long way before reaching
the final desideratum, i.e., getting the \verb|tsi148|
supported in a standard way in the mainline kernel tree.
\begin{Itemize}
\item The most important target should be now getting the VME driver out
of the \verb|./staging/| tree. For that purpose, code must be worked on
(or it'll die), and set up to the highest standard of quality to be
accepted in the mainline.
\end{Itemize}

\section{DRIVERS FOR THE FMC FAMILY}

In~\cite{fpga-fmc}, a family of carrier/mezzanine boards compliant with 
the ANSI VITA~57 FMC standard~\cite{} is described.
developed by the BE/CO Hardware and Timing section at CERN is
another case in point for the benefits of a Linux kernel-centric
approach. The hardware concept and architecture



\section{DATA ACQUISITION DRIVERS: THE COMEDI CASE}
\section{PLANS FOR THE FUTURE}
\section{ACKNOWLEDGEMENTS}


\subsection{General Layout}

These instructions are a typical implementation of the
requirements. Manuscripts should have:
\begin{Itemize}
    \item  Either A4 (21.0\,cm~$\times$~29.7\,cm; 8.27\,in~$\times$~11.69\,in) or US
           letter size (21\,cm~$\times$~27.9\,cm; 8.5\,in~$\times$~11.0\,in) paper.
    \item  Single spaced text in two columns of 82.5\,mm (3.25\,in) with 5.0\,mm
           (0.2\,in) separation.
    \item  The text located within the margins specified in Table~\ref{l2ea4-t1}
           to facilitate electronic processing of the PostScript file.
\end{Itemize}

\iffalse
\begin{table}[hbt]
   \centering
   \caption{Margin specifications}
   \begin{tabular}{lcc}
       \toprule
       \textbf{Margin} & \textbf{A4 Paper} & \textbf{US Letter Paper} \\ 
       \midrule
           Top         & 37\,mm             & 19\,mm (0.75\,in)        \\
          Bottom       & 19\,mm             & 19\,mm (0.75\,in)        \\
           Left        & 20\,mm             & 20\,mm (0.79\,in)        \\
           Right       & 20\,mm             & 26\,mm (1.02\,in)        \\
       \bottomrule
   \end{tabular}
   \label{l2ea4-t1}
\end{table}
\fi

The layout of the text on the page is illustrated in
Fig.~\ref{l2ea4-f1}. Note that the paper's title and the author list should be the width of the
full page.Tables and figures may span the whole 170\,mm page width,
if desired (see Fig.~\ref{l2ea4-f2}), but full-width figures should be placed at
either the top or bottom of a page to ensure a proper flow of the text (Word only).

\iffalse
\begin{figure}[htb]
   \centering
   \includegraphics*[width=65mm]{JACpic_mc.eps}
   \caption{Layout of papers.}
   \label{l2ea4-f1}
\end{figure}
\fi
\begin{figure*}[tb]
    \centering
    \includegraphics*[width=168mm]{JACpic2v2.eps}
    \caption{Example of a full-width figure showing the JACoW Team at their annual meeting in 2008. 
    The figure carries a multi-line caption which has to be justified, rather than centred.}
    \label{l2ea4-f2}
\end{figure*}

If a displayed equation needs a number, place it flush with the right
margin of the column (see Eq.~\ref{eq:units}). The equation itseld should be centred, if possible.
Units should be written
using the roman (standard) font, not the italic font.

\begin{equation}\label{eq:units}
    C_B={q^3\over 3\epsilon_{0} mc}=3.54\,\hbox{$\mu$eV/T}
\end{equation}

\section{STYLES}

Table~\ref{style-tab} summarises the fonts and spacings used in the styles of
a JACoW template (these are implemented in the \LaTeX\ class file).

\begin{table}
    \setlength\tabcolsep{4pt}
    \caption{Summary of Styles}
    \label{style-tab}
    \begin{tabular}{llcc}
        \toprule
        \textbf{Style} & \textbf{Font}               & \textbf{Space}  & \textbf{Space} \\
                       &                             & \textbf{Before} & \textbf{After} \\ 
        \midrule
         Title         & 14\,pt                      & 0\,pt           & 3\,pt  \\
                       & Upper case except for       &                 &      \\
                       & required lower case letters &                 &      \\   %corrected 080515 vrws requred 
                       & Bold                        &                 &      \\ 
         \midrule
          Author list  & 12\,pt                      & 9\,pt           & 12\,pt \\
                       & Upper and Lower case        &                 &      \\ 
         \midrule
         Section       & 12\,pt                      & 9\,pt           & 3\,pt  \\
         heading       & Uppercase                   &                 &      \\
                       & bold                        &                 &      \\ 
        \midrule
         Subsection    & 12\,pt                      & 6\,pt           & 3\,pt  \\
         heading       & Initial Caps                &                 &      \\
                       & Italic                      &                 &      \\ 
        \midrule
         Figure        & 10\,pt                      & 3\,pt           & 6\,pt  \\
         Captions      &                             &                 &      \\
        \midrule
         Table         & 10\,pt                      & 3\,pt           & 3\,pt  \\
         Captions      &                             &                 &      \\
        \midrule
         Equations     & 10\,pt base font            & 12\,pt          & 12\,pt \\
        \midrule
         References    & 10\,pt, justified with      & 0\,pt           & 0\,pt  \\
                       & 7\,mm hanging indent          &                 &      \\
        \bottomrule
    \end{tabular}
\end{table}


\section{CHECKLIST FOR ELECTRONIC PUBLICATION}

\begin{Itemize}
    \item  Use only Times or Times New Roman (standard, bold or italic) and Symbol 
    			fonts for text -- 10\,pt minimum except References which can be 9\,pt or 10\,pt.
    \item  Figures should use Times or Times New Roman (standard, bold or italic) and Symbol fonts when possible
            -- 6\,pt minimum.
    \item  Check that the PostScript file prints correctly.
    \item  Check that there are no page numbers.
    \item  Check that the margins on the printed version are within $\pm$1\,mm of the specification.
    \item  \LaTeX\ users can check their margins by invoking the
           \texttt{boxit} option.
\end{Itemize}

\begin{thebibliography}{9}   % Use for  1-9  references
%\begin{thebibliography}{99} % Use for 10-99 references

\bibitem{fpga-fmc}
P. Alvarez, M. Cattin, J. H. Lewis, J. Serrano, T. Wlostowski,
``FPGA Mezzanine Cards for CERN’s Accelerator Control System'',
ICALEPCS'09, Kobe, October 2009, WEB002, p.~376,
\texttt{http://www.JACoW.org}.

\bibitem{vita-fmc}
VME International Trade Association,
``FPGA Mezzanine Card (FMC) Standard'', \url{http://www.vita.com/}

\bibitem{exampl-ref}
A.N. Other, ``A Very Interesting Paper'', EPAC'96, Sitges, June 1996, MOPCH31, p. 7984 (1996),
\texttt{http://www.JACoW.org}.

\end{thebibliography}

\end{document}
